## **1. Установите iptables.**

```bash
sudo apt-get install iptables
```

## **2. Проверьте осталась ли возможность подключения по ssh к вашему серверу.**

```bash
ssh arzdez
```

```bash
Last login: Fri Dec 13 01:42:08 2024 from 217.65.223.39  
[student@S-vm-214 ~]$
```

Осталось.
## **3. Почему может пропасть такая возможность?**

Очевидное - ошибка с сетью, перезагрузка, сбой сервера (последнее проверено).

Менее очевидное - изменение конфигурации ssh-сервера.

Ну и входящие соединения на порт 22 (по умолчанию), используемый по умолчанию для SSH, могут быть заблокированы.

## **4. Откройте нужный порт на сервере чтобы восстановить подключение.**

Чтобы восстановить доступ по SSH, нужно убедиться, что порт 22 открыт. Для этого выполните следующие шаги:

```bash
sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT
```

где:
- `-A INPUT`: добавляем правило для входящих соединений.
- `-p tcp`: протокол tcp.
- `--dport 22`: порт 22 (ssh).
- `-j ACCEPT`: разрешаем соединения.

## **5. Это будет udp или tcp порт?**

Протокол tcp, т.к. ssh использует tcp с портом 22.

## **6. Сохраняются ли записанные вами правила после перезагрузки?**

Не сохраняются, если не применены специальные меры.

## **7. Как их сохранить?**

```bash
sudo iptables-save > /etc/iptables/rules.v4
```

```bash
sudo nano /etc/network/if-pre-up.d/iptables
```

```bash
#!/bin/sh
iptables-restore < /etc/iptables/rules.v4
```

```bash
sudo chmod +x /etc/network/if-pre-up.d/iptables
```

```bash
sudo apt-get install iptables-persistent
```

После система будет автоматически восстанавливать правила из файла `/etc/iptables/rules.v4` при каждом запуске.

Я на всякий случай перезагрузил сеть:

```bash
sudo systemctl restart NetworkManager
```

Затем ввел команды следующие:

```bash
iptables -L
echo "---"
cat /etc/iptables/rules.v4
```

Случилось следующее:

```bash
Chain INPUT (policy ACCEPT)  
target     prot opt source               destination            
ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:ssh  
ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:214  
  
Chain FORWARD (policy ACCEPT)  
target     prot opt source               destination            
  
Chain OUTPUT (policy ACCEPT)  
target     prot opt source               destination
---
# Generated by iptables-save v1.8.10 (nf_tables) on Fri Dec 13 23:13:02 2024  
*filter  
:INPUT ACCEPT [54464:21945378]  
:FORWARD ACCEPT [0:0]  
:OUTPUT ACCEPT [0:0]  
-A INPUT -p tcp -m tcp --dport 22 -j ACCEPT  
-A INPUT -p tcp -m tcp --dport 214 -j ACCEPT  
COMMIT  
# Completed on Fri Dec 13 23:13:02 2024
```
